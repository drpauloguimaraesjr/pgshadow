      "id": "80ed7f38-6e19-437e-8690-f751fb4a1085",
      "name": "9a. Construir Contexto Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -512,
        -480
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.context }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.7
        }
      },
      "id": "3087fb16-710c-491c-88d2-278641531275",
      "name": "10a. IA Gera Resposta",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        -352,
        -864
      ],
      "credentials": {
        "openAiApi": {
          "id": "z0yk9XmZziIdGBaN",
          "name": "OpenAi account 4"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse resposta final da IA\nconst currentItem = $('9a. Construir Contexto Resposta').first().json;\nconst aiResponse = $input.first().json.message?.content || $input.first().json.text || '{}';\n\nconsole.log('=== RESPOSTA FINAL IA ===');\nconsole.log(aiResponse);\n\nlet parsed;\ntry {\n  // Remover markdown\n  let jsonText = aiResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  \n  const jsonMatch = jsonText.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON n√£o encontrado');\n  }\n} catch (error) {\n  console.error('Erro ao fazer parse da resposta:', error);\n  parsed = {\n    urgencia: 'baixa',\n    sentimento: 'positivo',\n    categoria: 'analise_refeicao',\n    deve_responder: true,\n    resposta: aiResponse\n  };\n}\n\nreturn {\n  json: {\n    ...currentItem,\n    urgencia: parsed.urgencia || 'baixa',\n    sentimento: parsed.sentimento || 'positivo',\n    categoria: parsed.categoria || 'analise_refeicao',\n    deve_responder: parsed.deve_responder !== false,\n    resposta: parsed.resposta || aiResponse\n  }\n};"
      },
      "id": "c3d07fd0-904c-4012-82fa-2ee2bfbea5d1",
      "name": "11a. Parse Resposta Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        -480
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://nutribuddy.dog/api/n8n/conversations/{{ $('11a. Parse Resposta Final').first().json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "senderId",
              "value": "={{ $('11a. Parse Resposta Final').first().json.prescriberId }}"
            },
            {
              "name": "senderRole",
              "value": "prescriber"
            },
            {
              "name": "content",
              "value": "={{ $('11a. Parse Resposta Final').first().json.resposta }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "isAiGenerated",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "id": "dd0bbf0d-2856-4a2e-aba1-0c844f2ca3cc",
      "name": "12a. Enviar Resposta (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        -480
      ]
    },
    {
      "parameters": {
        "url": "=https://nutribuddy.dog/api/n8n/patients/{{ $('1. Validar e Processar').first().json.patientId }}/profile-macros",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "ce719d60-b957-4182-892d-578d49607256",
      "name": "5b. Buscar Macros Perfil (FALLBACK)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1408,
        -1328
      ]
    },
    {
      "parameters": {
        "jsCode": "// Verificar se tem dieta prescrita ou usar macros do perfil\nconst dietResponse = $input.first().json;\n\nconsole.log('=== VERIFICANDO DIETA ===');\nconsole.log('Diet response:', JSON.stringify(dietResponse, null, 2));\n\n// Verificar se tem dieta ativa\nconst hasDiet = dietResponse.data && \n                dietResponse.data.meals && \n                Array.isArray(dietResponse.data.meals) && \n                dietResponse.data.meals.length > 0;\n\nconsole.log('Has diet?', hasDiet);\n\nreturn {\n  json: {\n    hasDiet: hasDiet,\n    dietData: dietResponse.data || {}\n  }\n};"
      },
      "id": "40683e7b-3cb8-4df4-8dfb-2e9809dfd9ff",
      "name": "5c. Tem Dieta Prescrita?",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1200,
        -752
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasDiet }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "2b62e1bc-1360-4335-8859-25e717196ba6",
      "name": "5d. IF: Tem Dieta?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -912,
        -752
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar dieta prescrita\nconst currentItem = $('1. Validar e Processar').first().json;\nconst dietData = $input.first().json.dietData;\n\nconsole.log('=== USANDO DIETA PRESCRITA ===');\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'prescribed',\n    dietPlan: {\n      name: dietData.name || 'Dieta Prescrita',\n      description: dietData.description || '',\n      meals: dietData.meals || [],\n      dailyProtein: dietData.macros?.protein || 0,\n      dailyCarbs: dietData.macros?.carbs || 0,\n      dailyFats: dietData.macros?.fats || 0,\n      dailyCalories: dietData.macros?.calories || 0\n    }\n  }\n};"
      },
      "id": "3086d736-2cf2-4ef7-8699-7bcf86d3d64d",
      "name": "5e. Usar Dieta Prescrita",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -960,
        -1216
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar macros do perfil (fallback)\nconst currentItem = $('1. Validar e Processar').first().json;\nconst profileResponse = $('5b. Buscar Macros Perfil (FALLBACK)').first().json;\n\nconsole.log('=== USANDO MACROS DO PERFIL (FALLBACK) ===');\nconsole.log('Profile response:', JSON.stringify(profileResponse, null, 2));\n\nconst profileData = profileResponse.data || {};\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'profile',\n    dietPlan: {\n      name: profileData.name || 'Macros do Perfil',\n      description: profileData.description || 'Macronutrientes baseados no perfil do paciente',\n      meals: [], // Sem refei√ß√µes espec√≠ficas\n      dailyProtein: profileData.macros?.protein || 0,\n      dailyCarbs: profileData.macros?.carbs || 0,\n      dailyFats: profileData.macros?.fats || 0,\n      dailyCalories: profileData.macros?.calories || 0,\n      patientInfo: profileData.patientInfo || {}\n    }\n  }\n};"
      },
      "id": "de8c382d-9bb0-43ff-abcd-96b6c4c29eed",
      "name": "5f. Usar Macros do Perfil",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        -1328
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://nutribuddy.dog/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { type: 'meal_logging', patientId: $('1. Validar e Processar').first().json.patientId, data: $('7a. Parse An√°lise Foto').first().json.analise_foto } }}",
        "options": {}
      },
      "id": "9fe6b7bd-7a3c-4c0c-8226-9ea7452b13e2",
      "name": "FASE2: 1. Criar Contexto Inicial",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        272,
        -576
      ]
    },
    {
      "parameters": {
        "url": "=https://nutribuddy.dog/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "55466406-3d2a-4620-9db0-67cb9be9abe5",
      "name": "FASE2: 2. Buscar Contexto Ativo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1632,
        -64
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasContext }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "cdf5d0e7-6ec8-4813-af9b-6700d7126bab",
      "name": "FASE2: 3. Tem Contexto Ativo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1408,
        -64
      ]
    },
    {
      "parameters": {
        "jsCode": "// Analisar inten√ß√£o do usu√°rio quando h√° contexto ativo\nconst currentItem = $input.first().json;\nconst contextData = $('FASE2: 2. Buscar Contexto Ativo').first().json;\nconst userMessage = $('1. Validar e Processar').first().json.content.toLowerCase();\n\n// Palavras-chave para cada inten√ß√£o\nconst keywords = {\n  correction: ['na verdade', 'n√£o', 'errado', 'correto', 'corre√ß√£o', 'corrigir', 's√£o', 'peso', 'gramas', 'kg', 'metade', 'meio'],\n  addition: ['tamb√©m', 'mais', 'al√©m', 'comi', 'bebi', 'adicionar', 'incluir', 'tinha', 'tomei'],\n  confirmation: ['sim', 'confirmar', 'pode', 'registrar', 'salvar', 'ok', 'certo', 'isso mesmo', 'exato'],\n  cancellation: ['n√£o', 'cancelar', 'esquecer', 'desistir', 'n√£o quero', 'deixa pra l√°']\n};\n\n// Detectar inten√ß√£o\nlet intention = 'unknown';\nlet confidence = 0;\n\n// Verificar cada tipo de inten√ß√£o\nfor (const [type, words] of Object.entries(keywords)) {\n  const matches = words.filter(word => userMessage.includes(word)).length;\n  const score = matches / words.length;\n  \n  if (score > confidence) {\n    confidence = score;\n    intention = type;\n  }\n}\n\n// Se confian√ßa muito baixa, considerar como pergunta/d√∫vida\nif (confidence < 0.15) {\n  intention = 'question';\n}\n\nconsole.log('Inten√ß√£o detectada:', intention, 'Confian√ßa:', confidence);\n\nreturn {\n  json: {\n    conversationId: $('1. Validar e Processar').first().json.conversationId,\n    patientId: $('1. Validar e Processar').first().json.patientId,\n    context: contextData.context,\n    intention: {\n      type: intention,\n      confidence: confidence,\n      userMessage: $('1. Validar e Processar').first().json.content\n    }\n  }\n};"
      },
      "id": "d7552527-37ca-4cd9-9ac7-a7672289c089",
      "name": "FASE2: 4. Analisar Inten√ß√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1184,
        112
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{ $json.intention.type }}",
                    "value2": "correction"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{ $json.intention.type }}",
                    "value2": "addition"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{ $json.intention.type }}",
                    "value2": "confirmation"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{ $json.intention.type }}",
                    "value2": "cancellation"
                  }
                ]
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": 4
        }
      },
      "id": "22efbcf2-da0c-4d4f-8c57-649210546624",
      "name": "FASE2: 5. Rotear por Inten√ß√£o",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -960,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Processar corre√ß√£o de peso/quantidade\nconst currentItem = $input.first().json;\nconst context = currentItem.context;\nconst userMessage = currentItem.intention.userMessage;\n\nconsole.log('Processando corre√ß√£o:', userMessage);\n\n// Extrair n√∫meros da mensagem (peso em gramas)\nconst numbers = userMessage.match(/\\d+/g);\nlet newWeight = null;\n\nif (numbers && numbers.length > 0) {\n  newWeight = parseInt(numbers[0]);\n  \n  // Se mencionou \"metade\", \"meio\", dividir por 2\n  if (userMessage.includes('metade') || userMessage.includes('meio')) {\n    newWeight = Math.round(newWeight / 2);\n  }\n}\n\nconsole.log('Novo peso detectado:', newWeight);\n\n// Atualizar contexto com novo peso\nconst updatedFoods = context.data.foods.map(food => {\n  const ratio = newWeight ? newWeight / food.weight : 1;\n  return {\n    ...food,\n    weight: newWeight || food.weight,\n    macros: {\n      protein: Math.round(food.macros.protein * ratio * 10) / 10,\n      carbs: Math.round(food.macros.carbs * ratio * 10) / 10,\n      fats: Math.round(food.macros.fats * ratio * 10) / 10,\n      calories: Math.round(food.macros.calories * ratio)\n    }\n  };\n});\n\n// Recalcular totais\nconst totalMacros = updatedFoods.reduce((acc, food) => ({\n  protein: acc.protein + food.macros.protein,\n  carbs: acc.carbs + food.macros.carbs,\n  fats: acc.fats + food.macros.fats,\n  calories: acc.calories + food.macros.calories\n}), { protein: 0, carbs: 0, fats: 0, calories: 0 });\n\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    action: 'update',\n    contextUpdate: {\n      data: {\n        ...context.data,\n        foods: updatedFoods,\n        totalMacros: {\n          protein: Math.round(totalMacros.protein * 10) / 10,\n          carbs: Math.round(totalMacros.carbs * 10) / 10,\n          fats: Math.round(totalMacros.fats * 10) / 10,\n          calories: Math.round(totalMacros.calories)\n        }\n      }\n    },\n    responseMessage: `Entendi! Atualizei para ${newWeight}g. \n\nüìä Macros recalculados:\n- Prote√≠na: ${Math.round(totalMacros.protein)}g\n- Carboidratos: ${Math.round(totalMacros.carbs)}g\n- Gorduras: ${Math.round(totalMacros.fats)}g\n- Calorias: ${Math.round(totalMacros.calories)}\n\nTem mais alguma coisa nesta refei√ß√£o? ü§î`\n  }\n};"
      },
      "id": "3b4aa273-0624-4716-ab40-c8e6299a0d66",
      "name": "FASE2: 6a. A√ß√£o: Corre√ß√£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        -16
      ]
    },
    {
      "parameters": {
(Content truncated due to size limit. Use page ranges or line ranges to read remaining content)